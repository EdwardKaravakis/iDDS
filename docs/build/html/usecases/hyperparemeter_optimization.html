

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>HyperParameterOptimization(HPO) &mdash; iDDS 0.0.4 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Installing iDDS Clients" href="../users/installing_client.html" />
    <link rel="prev" title="Active Learning(AL)" href="active_learning.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> iDDS
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../general/requirements_functions.html">Functions and Example Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/schematic_view.html">Schematic View</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/architecture.html">Architecture</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="data_carousel.html">Data Carousel</a></li>
<li class="toctree-l1"><a class="reference internal" href="active_learning.html">Active Learning(AL)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">HyperParameterOptimization(HPO)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#idds-hpo-workflow">iDDS HPO workflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hyperparameter-generation">Hyperparameter Generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#restful-service">RESTful Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-defied-hpo-generator">User-defied HPO Generator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#communication-between-the-pilot-and-user-defined-hpo-training-program-container">Communication between the Pilot and User-defined HPO Training Program/Container</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#input-for-hpo-training-program-container">Input for HPO Training Program/Container</a></li>
<li class="toctree-l4"><a class="reference internal" href="#output-from-hpo-training-program-container">Output from HPO Training Program/Container</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../users/installing_client.html">Installing iDDS Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users/cli_examples.html">iDDS RESTful client: Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../codes/libraries.html">iDDS Codes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">iDDS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>HyperParameterOptimization(HPO)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/usecases/hyperparemeter_optimization.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hyperparameteroptimization-hpo">
<h1>HyperParameterOptimization(HPO)<a class="headerlink" href="#hyperparameteroptimization-hpo" title="Permalink to this headline">¶</a></h1>
<p>HPO is a usecase of iDDS. The purpose of iDDS HPO is to use iDDS to generate hyperparameters for machine learning and trigger production system to automatically process the machine learning training with provided hyperparameters.</p>
<div class="section" id="idds-hpo-workflow">
<h2>iDDS HPO workflow<a class="headerlink" href="#idds-hpo-workflow" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>The user submit a HPO task to JEDI.</p></li>
<li><p>JEDI submits a HPO request to iDDS.</p></li>
<li><p>iDDS generates multiple sets of hyperparameters and stores them in iDDS database. Each set of hyperparameters has a serial number and corresponds to a machine learning training job.</p></li>
<li><p>Serial numbers are sent to JEDI through ActiveMQ.</p></li>
<li><p>JEDI generates PanDA jobs and dispatches them to pilots running on compute resources.</p></li>
<li><p>Each PanDA job fetches a serial number from PanDA and converts it to a set of hyperparameters by checking with iDDS.</p></li>
<li><p>Once the hyperparameter set is evaluated the validation loss is registered to iDDS.</p></li>
<li><p>The PanDA job fetches another serial number and evaluates corresponding hyperparameter set if wall-time is still available.</p></li>
<li><p>When the number of unprocessed hyperparameter sets goes below a threshold, iDDS automatically generates new sets of hyperparameters. This step will continue until:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>The total number of groups of hyperparameters reaches max_points. This parameter can be defined in the request.</p></li>
<li><p>The hyperparameter generate process fails or returns [].</p></li>
</ol>
</div></blockquote>
</li>
<li><p>When all hyperparameter sets are evaluated iDDS sends a message to JEDI to terminate the HPO task.</p></li>
</ol>
<div class="section" id="hyperparameter-generation">
<h3>Hyperparameter Generation<a class="headerlink" href="#hyperparameter-generation" title="Permalink to this headline">¶</a></h3>
<dl>
<dt>Currently iDDS support several different ways to generate hyperparameters.</dt><dd><ol class="arabic">
<li><p>bayesian: This is a predefined method in iDDS.</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>The process to generate new hyperparameters: atlas/lib/idds/atlas/processing/hyperparameteropt_bayesian.py</p></li>
<li><p>The example code to generate requests: main/lib/idds/tests/hyperparameteropt_bayesian_test.py</p></li>
</ol>
</div></blockquote>
</li>
<li><p>nevergrad: This is another predefined method in iDDS.</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>The process to generate new hyperparameters: atlas/lib/idds/atlas/processing/hyperparameteropt_nevergrad.py</p></li>
<li><p>The example code to generate requests: main/lib/idds/tests/hyperparameteropt_nevergrad_test.py</p></li>
</ol>
</div></blockquote>
</li>
<li><p>container: Users can also define his own hyperparameter generator with container.</p>
<blockquote>
<div><ol class="loweralpha simple" start="2">
<li><p>Here is a docker example: main/lib/idds/tests/hyperparameteropt_docker_test.py</p></li>
</ol>
</div></blockquote>
</li>
</ol>
</dd>
</dl>
</div>
<div class="section" id="restful-service">
<h3>RESTful Service<a class="headerlink" href="#restful-service" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>To retrieve hyperparameters.</p>
<blockquote>
<div><p>client.get_hyperparameters(request_id, status=None, limit=None)</p>
</div></blockquote>
</li>
<li><p>To register loss of a group of hyperparameters.</p>
<blockquote>
<div><p>client.update_hyperparameter(request_id, id, loss)</p>
</div></blockquote>
</li>
<li><p>Example code: main/lib/idds/tests/hyperparameteropt_client_test.py</p></li>
</ol>
</div>
<div class="section" id="user-defied-hpo-generator">
<h3>User-defied HPO Generator<a class="headerlink" href="#user-defied-hpo-generator" title="Permalink to this headline">¶</a></h3>
<p>For iDDS HPO, users can define their own HPO generator through docker. When iDDS calls these generators, iDDS will provide these parameters:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>‘%MAX_POINTS’: max number of groups of hyperparameters. iDDS will not stop generating new hyperparameters until it receives an output []. So the generator needs to take care of the max number of points.</p></li>
<li><p>‘%NUM_POINTS’: The number of groups of hyperparameters per generation or per iteration. The default is 10. Users can also update it in the request with ‘num_points_per_generation’ in the request_metadata.</p></li>
<li><p>‘%IN’: Every time when iDDS calls the generator, iDDS will generate a json file ‘idds_input.json’ in the current working directory which includes all points(one point is a group of hyperparameter) with corresponding loss or None(if loss is not available). When using docker, users need to mount the current directory and tell the generator the file path in container.</p></li>
<li><p>‘%OUT’: The generator needs to create a an output json file which includes all new points. iDDS will read this file to parse all points. The ‘OUT’ file name is defined in the ‘output_json’ in the request_metadata.</p></li>
<li><p>input_idds.json: This a file created by iDDS as an input for %IN. Here is one example of idds_input.json(main/lib/idds/tests/idds_input.json). The format of idds_input.json is {“points”: [[hyperparameter, loss], [hyperparameter, null]], “opt_space”: &lt;opt space&gt;}. ‘opt_space’ is a copy of the content from your request. If in your request ‘opt_space’ is not defined, in idds_input.json ‘opt_space’ will be null(If a hyper parameter is not yet evaluated, the loss will be null(It’s None in python dictionary. After json.dumps, it’s converted to null). ‘points’ includes all hyper parameters, whether they are evaluated or not. If a hyper parameter is not yet evaluated, the loss will be null.</p></li>
<li><p>How to test the container. Here is one example. Users can update the request part and test their docker locally.</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="communication-between-the-pilot-and-user-defined-hpo-training-program-container">
<h3>Communication between the Pilot and User-defined HPO Training Program/Container<a class="headerlink" href="#communication-between-the-pilot-and-user-defined-hpo-training-program-container" title="Permalink to this headline">¶</a></h3>
<p>The pilot and user-defined HPO training program/container communicate with each other using the following files
in the current directory.
Their file names can be defined as HPO task parameters.</p>
<div class="section" id="input-for-hpo-training-program-container">
<h4>Input for HPO Training Program/Container<a class="headerlink" href="#input-for-hpo-training-program-container" title="Permalink to this headline">¶</a></h4>
<p>The pilot places two json files before running HPO training program/container.
One file contains a list of file names in the training dataset.
If those files are directly read from the storage the file contains a list of full paths.
The other file contains a set of hyperparameter to be evaluated.</p>
</div>
<div class="section" id="output-from-hpo-training-program-container">
<h4>Output from HPO Training Program/Container<a class="headerlink" href="#output-from-hpo-training-program-container" title="Permalink to this headline">¶</a></h4>
<p>HPO training program/container evaluates the hyperparameter set and produces one json file
which contains a dictionary with the following key-values: <code class="docutils literal notranslate"><span class="pre">status</span></code>: <code class="docutils literal notranslate"><span class="pre">integer</span></code> (0: OK, others: Not Good),
<code class="docutils literal notranslate"><span class="pre">loss</span></code>: <code class="docutils literal notranslate"><span class="pre">float</span></code>, <code class="docutils literal notranslate"><span class="pre">message</span></code>: <code class="docutils literal notranslate"><span class="pre">string</span></code> (optional). It is possible to produce another json file to report
job metadata to PanDA which can contain an arbitrary dictionary.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../users/installing_client.html" class="btn btn-neutral float-right" title="Installing iDDS Clients" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="active_learning.html" class="btn btn-neutral float-left" title="Active Learning(AL)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Wen Guan (Wisconsin, IRIS-HEP, ATLAS@CERN)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>